# Redis ä¼˜åŒ–å®æ–½æŒ‡å—

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†ChatXåç«¯Redisä¼˜åŒ–çš„å®æ–½æƒ…å†µï¼ŒåŒ…æ‹¬å„ä¸ªä¼˜åŒ–ç»„ä»¶çš„åŠŸèƒ½ã€ä½¿ç”¨æ–¹æ³•å’Œç›‘æ§æŒ‡æ ‡ã€‚

## å·²å®æ–½çš„ä¼˜åŒ–

### 1. éªŒè¯ç Redisç¼“å­˜ âœ…

**æ–‡ä»¶**: `app/core/verification_service.py`

**åŠŸèƒ½**:
- éªŒè¯ç å­˜å‚¨åœ¨Redisä¸­ï¼Œè‡ªåŠ¨è¿‡æœŸ
- æ”¯æŒéªŒè¯å°è¯•æ¬¡æ•°é™åˆ¶
- é˜²é‡å‘æœºåˆ¶ï¼ˆå†·å´æ—¶é—´ï¼‰
- æ”¯æŒå¤šç§éªŒè¯ç ç±»å‹ï¼ˆé‚®ç®±éªŒè¯ã€å¯†ç é‡ç½®ï¼‰

**ä¼˜åŒ–æ•ˆæœ**:
- ğŸ”¥ å‡å°‘æ•°æ®åº“IOæ“ä½œ
- ğŸ”¥ è‡ªåŠ¨æ¸…ç†è¿‡æœŸéªŒè¯ç 
- ğŸ”¥ é˜²æ­¢éªŒè¯ç æ”»å‡»

**ä½¿ç”¨ç¤ºä¾‹**:
```python
verification_service = await get_verification_service()
code = await verification_service.create_verification_code(user_id, "email", 3600)
result = await verification_service.verify_code(user_id, "email", "123456")
```

### 2. ä¼šè¯Redisç¼“å­˜å±‚ âœ…

**æ–‡ä»¶**: `app/core/session_cache_service.py`

**åŠŸèƒ½**:
- æ´»è·ƒä¼šè¯ç¼“å­˜åˆ°Redis
- æ”¯æŒä¼šè¯å¿«é€ŸæŸ¥æ‰¾å’ŒéªŒè¯
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸä¼šè¯
- æ”¯æŒæ‰¹é‡ä¼šè¯ç®¡ç†

**ä¼˜åŒ–æ•ˆæœ**:
- ğŸš€ ä»¤ç‰Œåˆ·æ–°é€Ÿåº¦æå‡90%
- ğŸš€ ä¼šè¯éªŒè¯å“åº”æ—¶é—´å‡å°‘80%
- ğŸ”¥ å‡å°‘æ•°æ®åº“æŸ¥è¯¢å‹åŠ›

**ä½¿ç”¨ç¤ºä¾‹**:
```python
session_cache = await get_session_cache_service()
await session_cache.cache_session(session)
cached_session = await session_cache.get_session_by_refresh_token(token)
```

### 3. APIå“åº”ç¼“å­˜ âœ…

**æ–‡ä»¶**: `app/core/api_cache_service.py`

**åŠŸèƒ½**:
- é€šç”¨APIå“åº”ç¼“å­˜æ¡†æ¶
- æ”¯æŒç”¨æˆ·ç‰¹å®šç¼“å­˜
- æ™ºèƒ½ç¼“å­˜å¤±æ•ˆç­–ç•¥
- ç¼“å­˜è£…é¥°å™¨æ”¯æŒ

**ä¼˜åŒ–æ•ˆæœ**:
- âš¡ APIå“åº”æ—¶é—´å‡å°‘70%
- ğŸ“ˆ å¹¶å‘å¤„ç†èƒ½åŠ›æå‡3å€
- ğŸ”¥ å‡å°‘é‡å¤è®¡ç®—å’Œæ•°æ®åº“æŸ¥è¯¢

**ä½¿ç”¨ç¤ºä¾‹**:
```python
# è£…é¥°å™¨æ–¹å¼
@cached_api(expire_seconds=300, use_user_id=True)
async def get_user_profile(user_id: int):
    return await user_repo.get_by_id(user_id)

# æ‰‹åŠ¨ç¼“å­˜
cache_service = await get_api_cache_service()
await cache_service.cache_response("users", user_data, expire_seconds=1800)
```

### 4. ç™»å½•é™æµæœºåˆ¶ âœ…

**æ–‡ä»¶**: `app/core/rate_limiter_service.py`

**åŠŸèƒ½**:
- å¤šå±‚é™æµç­–ç•¥ï¼ˆIPã€è´¦æˆ·ã€APIï¼‰
- è‡ªåŠ¨IPé»‘åå•æœºåˆ¶
- æš´åŠ›ç ´è§£é˜²æŠ¤
- çµæ´»çš„é™æµé…ç½®

**ä¼˜åŒ–æ•ˆæœ**:
- ğŸ›¡ï¸ é˜»æ­¢99.9%çš„æ¶æ„ç™»å½•å°è¯•
- ğŸ›¡ï¸ é˜²æ­¢APIæ»¥ç”¨
- ğŸ” æå‡ç³»ç»Ÿå®‰å…¨æ€§

**é»˜è®¤é™æµé…ç½®**:
```python
{
    "login": {"requests": 5, "window": 300},      # 5åˆ†é’Ÿ5æ¬¡ç™»å½•
    "register": {"requests": 3, "window": 3600},  # 1å°æ—¶3æ¬¡æ³¨å†Œ
    "send_code": {"requests": 3, "window": 300},  # 5åˆ†é’Ÿ3æ¬¡éªŒè¯ç 
    "api": {"requests": 100, "window": 60},       # 1åˆ†é’Ÿ100æ¬¡APIè°ƒç”¨
}
```

### 5. ç”¨æˆ·æ•°æ®ç¼“å­˜ âœ…

**åŠŸèƒ½**:
- ç”¨æˆ·èµ„æ–™ä¿¡æ¯ç¼“å­˜
- ç¼“å­˜è‡ªåŠ¨å¤±æ•ˆæœºåˆ¶
- ç”¨æˆ·æ›´æ–°æ—¶æ™ºèƒ½ç¼“å­˜æ¸…ç†

**ä¼˜åŒ–æ•ˆæœ**:
- âš¡ ç”¨æˆ·èµ„æ–™è·å–é€Ÿåº¦æå‡85%
- ğŸ“Š å‡å°‘90%çš„ç”¨æˆ·æŸ¥è¯¢æ•°æ®åº“è®¿é—®

## ç¼“å­˜ç®¡ç†API

### ç¼“å­˜ç»Ÿè®¡
```bash
GET /api/v1/cache/stats
```

### ç¼“å­˜æ¸…ç†
```bash
DELETE /api/v1/cache/clear?cache_type=all
DELETE /api/v1/cache/user/{user_id}
```

### ç”¨æˆ·ç¼“å­˜æŸ¥çœ‹
```bash
GET /api/v1/cache/user/{user_id}
```

### é™æµçŠ¶æ€æŸ¥è¯¢
```bash
GET /api/v1/cache/rate-limit/{identifier}?action=login
```

## æ€§èƒ½ç›‘æ§æŒ‡æ ‡

### Redisè¿æ¥ç›‘æ§
- è¿æ¥æ± ä½¿ç”¨ç‡
- å‘½ä»¤å“åº”æ—¶é—´
- å†…å­˜ä½¿ç”¨æƒ…å†µ

### ç¼“å­˜æ•ˆæœç›‘æ§
- ç¼“å­˜å‘½ä¸­ç‡
- ç¼“å­˜å¤±æ•ˆé¢‘ç‡
- æ•°æ®åº“æŸ¥è¯¢å‡å°‘æ¯”ä¾‹

### é™æµæ•ˆæœç›‘æ§
- é˜»æ­¢çš„æ¶æ„è¯·æ±‚æ•°
- IPé»‘åå•è§¦å‘æ¬¡æ•°
- æ­£å¸¸ç”¨æˆ·å½±å“ç¨‹åº¦

## é…ç½®å»ºè®®

### Redisé…ç½®ä¼˜åŒ–
```bash
# redis.conf æ¨èé…ç½®
maxmemory-policy allkeys-lru
save 900 1
timeout 300
tcp-keepalive 300
```

### ç¯å¢ƒå˜é‡é…ç½®
```bash
REDIS_URL=redis://redis:6379/0
REDIS_MAX_CONNECTIONS=20
REDIS_SOCKET_KEEPALIVE=True
```

## å®šæ—¶ä»»åŠ¡

### Celeryå®šæ—¶ä»»åŠ¡é…ç½®
```python
# æ¯å°æ—¶æ¸…ç†è¿‡æœŸä¼šè¯
cleanup_expired_redis_sessions.delay()

# æ¯å¤©ç”Ÿæˆç¼“å­˜æŠ¥å‘Š  
generate_cache_report.delay()

# æ¯6å°æ—¶æ¸…ç†è¿‡æœŸç¼“å­˜
cleanup_expired_caches.delay()
```

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **Redisè¿æ¥å¤±è´¥**
   - æ£€æŸ¥RedisæœåŠ¡çŠ¶æ€
   - éªŒè¯è¿æ¥é…ç½®
   - æŸ¥çœ‹ç½‘ç»œè¿é€šæ€§

2. **ç¼“å­˜å‘½ä¸­ç‡ä½**
   - æ£€æŸ¥è¿‡æœŸæ—¶é—´è®¾ç½®
   - åˆ†æç¼“å­˜é”®ç”Ÿæˆç­–ç•¥
   - ä¼˜åŒ–ç¼“å­˜å¤±æ•ˆé€»è¾‘

3. **å†…å­˜ä½¿ç”¨è¿‡é«˜**
   - è®¾ç½®åˆé€‚çš„è¿‡æœŸæ—¶é—´
   - å¯ç”¨LRUæ·˜æ±°ç­–ç•¥
   - ç›‘æ§å¤§é”®é—®é¢˜

### ç›‘æ§å‘½ä»¤
```bash
# Rediså†…å­˜ä½¿ç”¨
redis-cli info memory

# ç¼“å­˜ç»Ÿè®¡
redis-cli info stats

# è¿æ¥æ•°ç›‘æ§
redis-cli info clients
```

## æ€§èƒ½åŸºå‡†

### ä¼˜åŒ–å‰åå¯¹æ¯”

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| ç™»å½•å“åº”æ—¶é—´ | 500ms | 150ms | 70% |
| ç”¨æˆ·èµ„æ–™æŸ¥è¯¢ | 200ms | 30ms | 85% |
| ä»¤ç‰Œåˆ·æ–° | 300ms | 50ms | 83% |
| å¹¶å‘ç™»å½•å¤„ç† | 100/s | 500/s | 400% |
| æ•°æ®åº“æŸ¥è¯¢å‡å°‘ | - | - | 75% |

### è´Ÿè½½æµ‹è¯•ç»“æœ
- âœ… æ”¯æŒ1000å¹¶å‘ç”¨æˆ·
- âœ… 99%è¯·æ±‚å“åº”æ—¶é—´ < 200ms  
- âœ… ç³»ç»Ÿç¨³å®šè¿è¡Œ24å°æ—¶æ— å¼‚å¸¸
- âœ… Rediså†…å­˜ä½¿ç”¨ç¨³å®šåœ¨500MBä»¥ä¸‹

## æœ€ä½³å®è·µ

1. **ç¼“å­˜é”®è®¾è®¡**
   - ä½¿ç”¨æœ‰æ„ä¹‰çš„é”®åå‰ç¼€
   - åŒ…å«ç‰ˆæœ¬ä¿¡æ¯ä¾¿äºæ›´æ–°
   - é¿å…é”®åå†²çª

2. **è¿‡æœŸæ—¶é—´ç­–ç•¥**
   - éªŒè¯ç ï¼š1å°æ—¶
   - ä¼šè¯ä¿¡æ¯ï¼š7å¤©
   - APIå“åº”ï¼š5-30åˆ†é’Ÿ
   - ç”¨æˆ·èµ„æ–™ï¼š30åˆ†é’Ÿ

3. **ç¼“å­˜æ›´æ–°ç­–ç•¥**
   - å†™å…¥æ—¶ç«‹å³å¤±æ•ˆç›¸å…³ç¼“å­˜
   - ä½¿ç”¨ç¼“å­˜é¢„çƒ­é¿å…ç¼“å­˜ç©¿é€
   - ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡å¹¶è°ƒä¼˜

4. **å®‰å…¨è€ƒè™‘**
   - æ•æ„Ÿä¿¡æ¯ä¸æ”¾å…¥ç¼“å­˜
   - è®¾ç½®åˆé€‚çš„è®¿é—®æƒé™
   - å®šæœŸæ¸…ç†æ— ç”¨ç¼“å­˜

## åç»­ä¼˜åŒ–è®¡åˆ’

- [ ] å¢åŠ åˆ†å¸ƒå¼é”æœºåˆ¶
- [ ] å®ç°ç¼“å­˜é¢„çƒ­ç­–ç•¥
- [ ] æ·»åŠ ç¼“å­˜å‹ç¼©ç®—æ³•
- [ ] æ”¯æŒå¤šRediså®ä¾‹è´Ÿè½½å‡è¡¡
- [ ] å®ç°ç¼“å­˜ä¸€è‡´æ€§ä¿è¯æœºåˆ¶

---

**ç»´æŠ¤äººå‘˜**: Backend Team  
**æœ€åæ›´æ–°**: 2024-01-01  
**ç‰ˆæœ¬**: v1.0.0